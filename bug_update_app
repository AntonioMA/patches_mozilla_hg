# HG changeset patch
# Parent c45f6e6d6005ce895befc0242c427d5f71eacea5
# User Antonio M. Amaya <amac@tid.es>
Bug 1033453 - Fix the composed permission check on app updates

diff --git a/dom/apps/src/PermissionsInstaller.jsm b/dom/apps/src/PermissionsInstaller.jsm
--- a/dom/apps/src/PermissionsInstaller.jsm
+++ b/dom/apps/src/PermissionsInstaller.jsm
@@ -162,17 +162,17 @@ this.PermissionsInstaller = {
                 ? PermissionsTable[permName]["certified"]
                 : PermissionsTable[permName][appStatus];
 
           let permValue = PERM_TO_STRING[permission];
           if (!aIsSystemUpdate && isPromptPermission) {
             // If it's not a system update, then we should keep the prompt
             // permissions that have been granted or denied previously.
             permValue =
-              PermissionSettingsModule.getPermission(permName,
+              PermissionSettingsModule.getPermission(expandedPermNames[idx],
                                                      aApp.manifestURL,
                                                      aApp.origin,
                                                      false);
             if (permValue === "unknown") {
               permValue = PERM_TO_STRING[permission];
             }
           }
 
diff --git a/dom/apps/src/PermissionsTable.jsm b/dom/apps/src/PermissionsTable.jsm
--- a/dom/apps/src/PermissionsTable.jsm
+++ b/dom/apps/src/PermissionsTable.jsm
@@ -335,16 +335,25 @@ this.PermissionsTable =  { geolocation: 
                              app: DENY_ACTION,
                              privileged: ALLOW_ACTION,
                              certified: ALLOW_ACTION
                            },
                            "mobileid": {
                              app: DENY_ACTION,
                              privileged: PROMPT_ACTION,
                              certified: PROMPT_ACTION
+                           },
+                           // This permission doesn't actually grant access to
+                           // anything. It exists only to check the correctness
+                           // of web prompt composed permissions in tests.
+                           "test-permission": {
+                             app: PROMPT_ACTION,
+                             privileged: PROMPT_ACTION,
+                             certified: ALLOW_ACTION,
+                             access: ["read", "write", "create"]
                            }
                          };
 
 /**
  * Append access modes to the permission name as suffixes.
  *   e.g. permission name 'contacts' with ['read', 'write'] =
  *   ['contacts-read', contacts-write']
  * @param string aPermName
diff --git a/dom/apps/tests/file_packaged_app.template.webapp b/dom/apps/tests/file_packaged_app.template.webapp
--- a/dom/apps/tests/file_packaged_app.template.webapp
+++ b/dom/apps/tests/file_packaged_app.template.webapp
@@ -3,16 +3,17 @@
   "version" : "VERSIONTOKEN",
   "size" : PACKAGESIZETOKEN,
   "package_path": "PACKAGEPATHTOKEN",
   "description": "Updated even faster than Firefox, just to annoy slashdotters",
   "permissions": {
      "geolocation": {},
      "audio-capture": {},
      "video-capture": {},
+     "test-permission": {"access": "readonly"},
      "downloads": {}
    },
   "launch_path": "tests/dom/apps/tests/file_packaged_app.sjs",
   "developer": {
     "name": "DEVELOPERTOKEN",
     "url": "DEVELOPERURLTOKEN"
   },
   "default_locale": "en-US"
diff --git a/dom/apps/tests/test_packaged_app_update.html b/dom/apps/tests/test_packaged_app_update.html
--- a/dom/apps/tests/test_packaged_app_update.html
+++ b/dom/apps/tests/test_packaged_app_update.html
@@ -90,28 +90,31 @@ function updateApp(aExpectedReady, aPrev
                  null, true);
 
 }
 
 var initialPermissionState = {
   "geolocation": "prompt",
   "audio-capture": "prompt",
   "video-capture": "prompt",
+  "test-permission-read": "prompt",
   "downloads": "deny"
 }
 
 var permissionsToSet = {
   "geolocation": "allow",
+  "test-permission-read": "allow",
   "audio-capture": "deny"
 }
 
 var permissionsToCheck = {
   "geolocation": "allow",
   "audio-capture": "deny",
   "video-capture": "prompt",
+  "test-permission-read": "allow",
   "downloads": "deny"
 }
 
 function validatePermissions(aList, aDontFail) {
   var gApp = PackagedTestHelper.gApp;
   var mozPermissions = window.navigator.mozPermissionSettings;
   var permission;
   for (permission in aList) {
