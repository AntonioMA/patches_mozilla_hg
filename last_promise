# HG changeset patch
# Parent 8cb0b1dc8aa1556008c45a8c961b2ff0b7e3b1ce
# User Antonio M. Amaya <amac@tid.es>
Bug 903291 - Reject the promise when cancelling the download

diff --git a/dom/apps/src/Webapps.jsm b/dom/apps/src/Webapps.jsm
--- a/dom/apps/src/Webapps.jsm
+++ b/dom/apps/src/Webapps.jsm
@@ -3497,29 +3497,32 @@ this.DOMApplicationRegistry = {
       }
 
     } else if (isInstalled) {
       throw "WRONG_APP_STORE_ID";
     }
   },
 
   // Removes the directory we created, and sends an error to the DOM side.
+  // Note that this will be evaluated as a rejection callback for a promise,
+  // and we don't want the new promise to be fulfilled either.
   _revertDownloadPackage: function(aId, aOldApp, aNewApp, aIsUpdate, aError) {
     debug("Cleanup: " + aError + "\n" + aError.stack);
     let dir = FileUtils.getDir("TmpD", ["webapps", aId], true, true);
     try {
       dir.remove(true);
     } catch (e) { }
 
     // We avoid notifying the error to the DOM side if the app download
     // was cancelled via cancelDownload, which already sends its own
     // notification.
     if (aOldApp.isCanceling) {
       delete aOldApp.isCanceling;
-      return;
+      // Progress the error so that the returned promise is rejected also.
+      throw aError;
     }
 
     let download = AppDownloadManager.get(aNewApp.manifestURL);
     aOldApp.downloading = false;
 
     // If there were not enough storage to download the package we
     // won't have a record of the download details, so we just set the
     // installState to 'pending' at first download and to 'installed' when
